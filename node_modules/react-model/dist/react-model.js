var e,t=require("immer"),r=(e=t)&&"object"==typeof e&&"default"in e?e.default:e,n=require("react");function o(){return(o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function i(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,(Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var a={Actions:{},AsyncState:{},Context:{__global:{}},Middlewares:{},Setter:{classSetter:void 0,functionSetter:{}},State:{},devTools:void 0,subscriptions:{},mutableState:{},gid:0,uid:0,storeId:0,currentStoreId:"0",withDevTools:!1},c={logger:{enable:!1},devtools:{enable:!1},tryCatch:{enable:!0}},s=function(e,t){try{var r=e.next;return Promise.resolve(c.tryCatch.enable?r(t).catch(function(e){return console.log(e)}):r(t))}catch(e){return Promise.reject(e)}},u=function(e,t){try{var r=function(){return Promise.resolve(s(t))},n=e.action,i=e.modelName,a=e.consumerActions,c=e.params,s=e.next,u=e.Global,l=e.type,f=function(){if("u"!==l)return Promise.resolve(n(c,o({actions:a(u.Actions[i],{modelName:i}),state:u.State[i]},u.Context.__global||{},u.Context[i]||{}))).then(function(t){e.newState=t||null});e.newState=n()}();return Promise.resolve(f&&f.then?f.then(r):r())}catch(e){return Promise.reject(e)}},l=function(e,t){try{var r=e.modelName,n=e.newState,o=e.next,i=e.Global,a=e.type;return i.Setter.functionSetter[r]&&!e.disableSelectorUpdate&&Object.keys(i.Setter.functionSetter[r]).map(function(e){var t=i.Setter.functionSetter[r][e];t&&t.selector&&!t.selectorRef&&(t.selectorRef=t.selector(i.State[r]))}),Promise.resolve(function(){if(n||"u"===a)return N(r,n||{}),Promise.resolve(o(t))}())}catch(e){return Promise.reject(e)}},f=function(e,t){try{var r=e.modelName,n=e.next,o=e.Global,i=e.__hash,a=o.Setter.functionSetter[r];return"f"===e.type&&i&&a&&a[i]&&a[i].setState&&a[i].setState(o.State[r]),Promise.resolve(n(t))}catch(e){return Promise.reject(e)}},m=function(e,t){try{var r=e.modelName,n=e.next,o=e.Global,i="u"===e.type?o.subscriptions[r]:o.subscriptions[r+"_"+e.actionName];return i&&i.forEach(function(t){t(e)}),Promise.resolve(n(t))}catch(e){return Promise.reject(e)}},S=function(e,t){try{var r=e.Global;return!0===c.logger.enable||"function"==typeof c.logger.enable&&c.logger.enable(e)?(console.group("%c "+e.modelName+" State Change %c "+(new Date).toLocaleTimeString(),"color: gray; font-weight: lighter;","color: black; font-weight: bold;"),console.log("%c Previous","color: #9E9E9E; font-weight: bold",r.State[e.modelName]),console.log("%c Action","color: #03A9F4; font-weight: bold",e.actionName,"payload: "+e.params),Promise.resolve(e.next(t)).then(function(t){return console.log("%c Next","color: #4CAF50; font-weight: bold",r.State[e.modelName]),console.groupEnd(),t})):Promise.resolve(e.next(t))}catch(e){return Promise.reject(e)}},d=function(e,t){try{var r=e.Global;return Promise.resolve(e.next(t)).then(function(t){return r.withDevTools="undefined"!=typeof window&&window.__REDUX_DEVTOOLS_EXTENSION__,r.withDevTools&&v.config.devtools.enable&&!r.devTools&&(r.devTools=window.__REDUX_DEVTOOLS_EXTENSION__,r.devTools.connect()),r.withDevTools&&c.devtools.enable&&r.devTools.send("u"===e.type&&e.disableSelectorUpdate?"store["+e.modelName+"].update":e.modelName+"_"+e.actionName,"u"===e.type?r.mutableState[e.modelName]:r.State[e.modelName],void 0,e.modelName),t})}catch(e){return Promise.reject(e)}},p=function(e,t){try{var r=e.modelName,n=e.next,o=e.Global,i=e.disableSelectorUpdate;return o.Setter.classSetter&&o.Setter.classSetter(o.State),o.Setter.functionSetter[r]&&Object.keys(o.Setter.functionSetter[r]).map(function(e){var t=o.Setter.functionSetter[r][e];if(t)if(!t.selector||i)t.setState(o.State[r]);else{var n=t.selector(o.State[r]);x(n,t.selectorRef)||(t.selectorRef=n,t.setState(o.State[r]))}}),Promise.resolve(n(t))}catch(e){return Promise.reject(e)}},b=[s,S,d,u,l,f,p,m],v={communicator:p,consoleDebugger:S,devToolsListener:d,getNewState:u,getNewStateWithCache:function(e){return void 0===e&&(e=5e3),function(t,r){try{var n=t.Global,o=t.modelName,i=t.next,a=t.actionName;return Promise.resolve(Promise.race([(0,t.action)(t.params,{actions:(0,t.consumerActions)(n.Actions[o],{modelName:o}),state:n.State[o]}),O(e,j(o,a))])).then(function(e){return t.newState=e||null,Promise.resolve(i(r))})}catch(e){return Promise.reject(e)}}},setNewState:l,stateUpdater:f,subscription:m,tryCatch:s,config:c},_=function(e,t){try{return t.next=function(e){return e.length>0?e[0](t,e.slice(1)):t.newState},Promise.resolve(e[0](t,e.slice(1)))}catch(e){return Promise.reject(e)}},h=n.createContext({}),y=h.Consumer;if(!console.group){var g=[],P="-".repeat(80);console.group=function(e){g.push(e),console.log("%c \nBEGIN GROUP: %c",P,e),console.groupEnd=function(){console.log("END GROUP: %c\n%c",g.pop(),P)}}}var w=function(e,t){var r={};return Object.keys(e).forEach(function(n){r[n]=function(e,t){return function(r,n){try{return Promise.resolve(_(b,{Global:a,action:e,actionName:e.name,consumerActions:w,middlewareConfig:n,modelName:t.modelName,newState:null,params:r,type:"o"}))}catch(e){return Promise.reject(e)}}}(e[n],t)}),r},N=function(e,t){if("function"==typeof t){var n=a.State[e];n=r(n,t),a.State=r(a.State,function(t){t[e]=n})}else a.State=r(a.State,function(r){r[e]=o({},r[e],t)});return a.State},O=function(e,t){return new Promise(function(r){return setTimeout(function(){console.log(e),r(t)},e)})},E=function(e,t){try{var n={__FROM_SERVER__:!0};return Promise.resolve(Promise.all(Object.keys(a.State).map(function(i){try{var c=t&&t.prefix||"",s=function(){if(!e||!e.modelName||i===c+e.modelName||-1!==e.modelName.indexOf(c+i)){var s=function(e){t&&t.isServer?n[i]=e:a.State=r(a.State,function(t){t[i]=o({},t[i],e)})},u=a.AsyncState[i];return u?Promise.resolve(u(e)).then(s):s({})}}();return Promise.resolve(s&&s.then?s.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}))).then(function(){return t&&t.isServer?n:a.State})}catch(e){return Promise.reject(e)}},j=function(e,t){var r=localStorage.getItem("__REACT_MODELX__"+e+"_"+t);return r?JSON.parse(r):null},x=function(e,t){if(e===t)return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;var r=Object.keys(e),n=Object.keys(t);if(r.length!==n.length)return!1;for(var o=0;o<r.length;o++)if(!Object.prototype.hasOwnProperty.call(t,r[o])||e[r[o]]!==t[r[o]])return!1;return!0};t.enableES5();var A="undefined"==typeof window?n.useEffect:n.useLayoutEffect,R=function(e,t){C(e,t,void 0)},C=function(e,t,r){Array.isArray(t)?t.forEach(function(t){a.subscriptions[e+"_"+t]||(a.subscriptions[e+"_"+t]=[]),r?a.subscriptions[e+"_"+t].push(r):a.subscriptions[e+"_"+t]=[]}):(a.subscriptions[e+"_"+t]||(a.subscriptions[e+"_"+t]=[]),r?a.subscriptions[e+"_"+t].push(r):a.subscriptions[e+"_"+t]=[])},T=function(e){return a.State[e]},I=function(e,t){void 0===t&&(t={type:"o"});var r={};return Object.keys(a.Actions[e]).forEach(function(n){return r[n]=function(r,i){try{var c=o({action:a.Actions[e][n],actionName:n,consumerActions:w,middlewareConfig:i,modelName:e,newState:null,params:r},t,{Global:a});return Promise.resolve(_(a.Middlewares[e]?a.Middlewares[e]:b,c))}catch(e){return Promise.reject(e)}}}),r},M=function(e,t){var r,o=n.useState({})[1],i=n.useRef(""),c=(r=[e],function(e){return r.reduce(function(e,t){return e&&e[t]?e[t]:null},e)})(a.mutableState),s=!!c,u=s?c.selector:t,l=s?c:T(e);if(A(function(){a.uid+=1;var t=""+a.uid;return i.current=t,a.Setter.functionSetter[e]||(a.Setter.functionSetter[e]={}),a.Setter.functionSetter[e][t]={setState:o,selector:u},function(){delete a.Setter.functionSetter[e][t]}},[]),s)return u(l);var f=I(e,{__hash:i.current,type:"f"});return[u?u(l):l,f]},G=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).state=a.State,t}return i(t,e),t.prototype.render=function(){var e=this.props.children;return a.Setter.classSetter=this.setState.bind(this),n.createElement(h.Provider,{value:o({},this.state)},e)},t}(n.PureComponent);exports.Consumer=y,exports.Model=function(e,t,n){if(void 0!==e.state){a.storeId+=1;var i="__"+a.storeId;a.State=r(a.State,function(t){t[i]=e.state}),e.middlewares&&(a.Middlewares[i]=e.middlewares),a.Actions[i]=e.actions,a.AsyncState[i]=e.asyncState,t&&(a.Context[i]=t);var c=I(i);return{__id:i,actions:c,getState:function(){return T(i)},subscribe:function(e,t){return C(i,e,t)},unsubscribe:function(e){return R(i,e)},useStore:function(e){return M(i,e)}}}t?a.gid=1:a.gid+=1;var s="";if(a.gid>1&&(s=a.gid+"_"),e.actions){console.error("invalid model(s) schema: ",e);var u=function(e){return function(){return e}};return{__ERROR__:!0,actions:u({}),getActions:u({}),getInitialState:u({}),getState:u({}),subscribe:u(),unsubscribe:u(),useStore:u([{},{}])}}t&&!t.__FROM_SERVER__&&(a.State=r(a.State,function(e){Object.assign(e,t||{})})),n&&(a.Context.__global=n);var l={};return Object.keys(e).forEach(function(n){var i=s+n,c=e[n];if(c.__ERROR__)return console.error(i+" model's schema is invalid"),a.State=r(a.State,function(e){e[i]={}}),void(a.Actions[i]={});void 0===c.useStore?(t&&t.__FROM_SERVER__?a.State=r(a.State,function(e){e[i]=o({},c.state,t[i])}):a.State[i]||(a.State=r(a.State,function(e){e[i]=c.state})),c.middlewares&&(a.Middlewares[i]=c.middlewares),a.Actions[i]=c.actions,a.AsyncState[i]=c.asyncState):(a.State[i]&&t||(a.State=r(a.State,function(e){e[i]=e[c.__id]})),t&&t.__FROM_SERVER__&&(a.State=r(a.State,function(e){e[i]=o({},e[c.__id],t[i])})),a.Actions[i]=a.Actions[c.__id],a.AsyncState[i]=a.AsyncState[c.__id],a.Middlewares[i]=a.Middlewares[c.__id],a.Context[i]=a.Context[c.__id]),l[n]=I(i)}),{actions:l,getActions:function(e){return I(s+e)},getInitialState:function(e,t){try{return Promise.resolve(E(e,o({},t,{prefix:s})))}catch(e){return Promise.reject(e)}},getState:function(e){return T(s+e)},subscribe:function(e,t,r){return C(s+e,t,r)},unsubscribe:function(e,t){return R(s+e,t)},useStore:function(e,t){return M(s+e,t)}}},exports.Provider=G,exports.actionMiddlewares=b,exports.connect=function(e,t,r){return function(c){return function(s){function u(){return s.apply(this,arguments)||this}return i(u,s),u.prototype.render=function(){var i=this,s=this.props,u=s.state,l=void 0===u?{}:u,f=s.actions,m=void 0===f?{}:f;return n.createElement(y,null,function(s){var u=s[""+e],f=a.Actions[e];return n.createElement(c,Object.assign({},i.props,{state:o({},l,t?t(u):u),actions:o({},m,r?r(w(f,{modelName:e})):w(f,{modelName:e}))}))})},u}(n.PureComponent)}},exports.createStore=function(e,t){var r="string"==typeof e;a.storeId+=r?0:1;var n=r?e:a.storeId.toString();a.Actions[n]||(a.Actions[n]={}),a.mutableState[n]||(a.mutableState[n]={count:0});var o=function(){return a.mutableState[n].count=0,a.currentStoreId=n,a.mutableState[n].cachedResult=t?t():e(),a.mutableState[n].cachedResult};return a.mutableState[n].selector=o,{useStore:function(){return M(n,o)},getState:function(){return o()},getStore:function(){return a.mutableState[n].cachedResult},subscribe:function(e){a.subscriptions[n]||(a.subscriptions[n]=[]),a.subscriptions[n].push(e)},unsubscribe:function(e){if(a.subscriptions[n]&&e){var t=a.subscriptions[n].indexOf(e);t>=0&&a.subscriptions[n].splice(t,1)}}}},exports.getInitialState=E,exports.getState=T,exports.middlewares=v,exports.useModel=function(e){var t=a.currentStoreId,n=a.mutableState[t].count;return a.mutableState[t].count+=1,a.mutableState[t].hasOwnProperty(n)||(a.mutableState[t][n]="function"==typeof e?e():e),[a.mutableState[t][n],function(e){try{return a.mutableState[t][n]="function"==typeof e?r(a.mutableState[t][n],e):a.mutableState[t][n]&&e&&"Object"===a.mutableState[t][n].constructor.name&&"Object"===e.constructor.name?o({},a.mutableState[t][n],e):e,Promise.resolve(_(b,{Global:a,action:function(){return"function"==typeof e?a.mutableState[t][n]:e},actionName:"setter",consumerActions:w,disableSelectorUpdate:!0,middlewareConfig:{},modelName:t,newState:{},params:void 0,type:"u"}))}catch(e){return Promise.reject(e)}}]};
